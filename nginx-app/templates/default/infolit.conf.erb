<%= render_upstream(@php_upstream, 'infolit') %>

<% if node['opsworks'] -%>

server {
    listen 80 <%=@listen_opts%>;
    return 301 https://<%=node['infolit']['domain']%>$request_uri;
}

<% end -%>

server {

<% if !node['opsworks'] -%>
    listen 80;
<% else -%>
    listen 443;

    ssl                       on;
    ssl_certificate           /etc/nginx/ssl/cert.pem;
    ssl_certificate_key       /etc/nginx/ssl/cert.key;
    ssl_ciphers               RC4:HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
<% end -%>

<% if @nginx_extra -%>
    <%= @nginx_extra -%>
<% end -%>

    root <%= @deploy['deploy_to'] %>/current/<%= node['docroot'] %>;

    <%= render 'partials/status-checks.erb',
      :cookbook => 'nginx-app',
      :variables => {
        :access_log => @access_log,
        :health_check => "health_check.php",
        :upstream => 'infolit'
      }
    %>

    rewrite ^(/favicon.ico)$ /static/images/favicon.ico;

<% ['js', 'images', 'css'].each do |route_name| -%>
    location /<%=route_name%>/ {
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www/<%=route_name%>/;
        access_log <%= @access_log %>;
        add_header Access-Control-Allow-Origin *;
    }
<% end -%>

    location /static/ {
    <% if node['opsworks'] -%>
        expires    30d;
        add_header Pragma public;
        add_header Cache-Control "public";
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www-build/static/;
    <% else -%>
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www-src/static/;
    <% end -%>
        access_log <%= @access_log %>;
        add_header Access-Control-Allow-Origin *;
    }

    <%= render 'partials/php-fpm.erb',
      :cookbook => 'nginx-app',
      :variables => {
        :access_log => @access_log,
        :deploy_to => @deploy['deploy_to'],
        :docroot => node['docroot'],
        :index => 'search.php',
        :location => '/search/',
        :nginx_config_dir => node['nginx-app']['config_dir'],
        :upstream_name => 'infolit'
      }
    %>

    <%= render 'partials/php-fpm.erb',
      :cookbook => 'nginx-app',
      :variables => {
        :access_log => @access_log,
        :deploy_to => @deploy['deploy_to'],
        :docroot => node['docroot'],
        :index => 'index.php',
        :location => '/',
        :nginx_config_dir => node['nginx-app']['config_dir'],
        :upstream_name => 'infolit'
      }
    %>
}
