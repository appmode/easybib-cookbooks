<%= render_upstream(@php_upstream, 'infolit') %>

<% if node['opsworks'] -%>

server {
    listen 80 <%=@listen_opts%>;
    return 301 https://<%=node['infolit']['domain']%>$request_uri;
}

<% end -%>

server {

<% if !node['opsworks'] -%>
    listen 80;
<% else -%>
    listen 443;

    ssl                       on;
    ssl_certificate           /etc/nginx/ssl/cert.pem;
    ssl_certificate_key       /etc/nginx/ssl/cert.key;
    ssl_ciphers               RC4:HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
<% end -%>

<% if @nginx_extra -%>
    <%= @nginx_extra -%>
<% end -%>

    root <%= @deploy['deploy_to'] %>/current/<%= node['docroot'] %>;

    <%= render 'partials/status-checks.erb',
      :cookbook => 'nginx-app',
      :variables => {
        :access_log => @access_log,
        :health_check => "health_check.php",
        :upstream => 'infolit'
      }
    %>

    rewrite ^(/favicon.ico)$ /static/images/favicon.ico;

<% ['js', 'images', 'css'].each do |route_name| -%>
    location /<%=route_name%>/ {
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www/<%=route_name%>/;
        access_log <%= @access_log %>;
        add_header Access-Control-Allow-Origin *;
    }
<% end -%>

    location /static/ {
    <% if node['opsworks'] -%>
        expires    30d;
        add_header Pragma public;
        add_header Cache-Control "public";
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www-build/static/;
    <% else -%>
        alias      <%= @deploy['deploy_to'] %>/current/app/modules/infolit/www-src/static/;
    <% end -%>
        access_log <%= @access_log %>;
        add_header Access-Control-Allow-Origin *;
    }

    location /search/ {

        access_log off;
        include <%=node['nginx-app']['config_dir']%>/fastcgi_params;

        fastcgi_pass  infolit_phpfpm;
        fastcgi_index search.php;
        fastcgi_param SCRIPT_FILENAME <%= @deploy['deploy_to'] %>/current/<%= node['docroot'] %>/search.php;
        index  search.php;
    }

    location / {

        access_log <%= @access_log %>;

        include <%=node['nginx-app']['config_dir']%>/fastcgi_params;

        fastcgi_pass  infolit_phpfpm;
        fastcgi_index index.php;

        fastcgi_param SCRIPT_FILENAME <%= @deploy['deploy_to'] %>/current/<%= node['docroot'] %>/index.php;

        index  index.php index.html index.htm;
    }
}
